<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FuelSystem Pro v4.3 - SEGURIDAD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-100 min-h-screen pb-20">

    <nav class="bg-blue-900 text-white p-4 sticky top-0 z-50 shadow-xl">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="font-black italic">⛽ FUEL-MASTER v4.3</h1>
            <div class="flex space-x-2">
                <button onclick="verTab('ventas')" class="bg-blue-700 px-3 py-1 rounded text-xs">VENTAS</button>
                <button onclick="verTab('compras')" class="bg-emerald-700 px-3 py-1 rounded text-xs">COMPRAS</button>
                <button onclick="verTab('admin')" class="bg-slate-700 px-3 py-1 rounded text-xs">ADMIN / BACKUP</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 max-w-6xl">

        <div class="grid grid-cols-3 gap-2 mb-4 text-center">
            <div class="bg-white p-2 rounded shadow border-b-2 border-orange-500">
                <p class="text-[10px] uppercase font-bold text-gray-400">Súper</p>
                <p class="font-black text-sm"><span id="stk_super">0</span> <small>Gls</small></p>
                <p class="text-[9px] text-blue-600 font-bold">$<span id="prc_super">0</span></p>
            </div>
            <div class="bg-white p-2 rounded shadow border-b-2 border-red-500">
                <p class="text-[10px] uppercase font-bold text-gray-400">Regular</p>
                <p class="font-black text-sm"><span id="stk_regular">0</span> <small>Gls</small></p>
                <p class="text-[9px] text-blue-600 font-bold">$<span id="prc_regular">0</span></p>
            </div>
            <div class="bg-white p-2 rounded shadow border-b-2 border-black">
                <p class="text-[10px] uppercase font-bold text-gray-400">Diésel</p>
                <p class="font-black text-sm"><span id="stk_diesel">0</span> <small>Gls</small></p>
                <p class="text-[9px] text-blue-600 font-bold">$<span id="prc_diesel">0</span></p>
            </div>
        </div>

        <section id="sec-compras" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-emerald-600 mb-6">
                <h2 class="text-lg font-bold mb-4 italic">📥 Registro de Abastecimiento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="date" id="c_fecha" class="p-3 border rounded-xl bg-gray-50">
                    <input type="text" id="c_factura" placeholder="No. Factura / Referencia" class="p-3 border rounded-xl font-bold">
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <select id="c_prod" class="p-3 border rounded-xl font-bold bg-gray-50">
                        <option value="Súper">Gasolina Súper</option>
                        <option value="Regular">Gasolina Regular</option>
                        <option value="Diésel">Diésel</option>
                    </select>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="c_cant" oninput="calcCostoCompra()" placeholder="Cantidad (Gls)" class="p-3 border rounded-xl">
                        <input type="number" id="c_costo_total" oninput="calcCostoCompra()" placeholder="Costo Total ($)" class="p-3 border rounded-xl bg-orange-50">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="p-2 bg-gray-100 rounded-lg text-center">
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Costo Unitario</p>
                            <p id="c_unitario_show" class="font-bold text-orange-600">$0.00</p>
                        </div>
                        <input type="number" id="c_precio_venta" placeholder="Precio Venta Final ($)" class="p-3 border rounded-xl bg-blue-50 font-bold">
                    </div>
                    <div class="flex space-x-2">
                        <input type="hidden" id="c_edit_index" value="-1">
                        <button onclick="cancelarCompra()" class="bg-slate-500 text-white px-4 py-3 rounded-xl font-bold uppercase text-xs">Limpiar</button>
                        <button id="btn-comprar" onclick="registrarCompra()" class="flex-1 bg-emerald-600 text-white p-4 rounded-xl font-bold uppercase shadow">Guardar Compra</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-3 bg-emerald-800 text-white text-xs font-bold uppercase flex justify-between items-center">
                    <span>Historial de Compras</span>
                    <button onclick="exportarExcelCompras()" class="bg-white text-emerald-800 px-2 py-1 rounded text-[10px] font-black">EXCEL + TOTALES</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-[10px] text-left border-collapse">
                        <thead class="bg-gray-100 border-b text-gray-400">
                            <tr>
                                <th class="p-2">Fecha/Factura</th>
                                <th class="p-2">Producto</th>
                                <th class="p-2 text-center">Cant.</th>
                                <th class="p-2 text-center">Unitario</th>
                                <th class="p-2 text-right">Costo Total</th>
                                <th class="p-2 text-center">⚙️</th>
                            </tr>
                        </thead>
                        <tbody id="lista_compras" class="divide-y text-gray-600 italic"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="sec-ventas">
            <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-blue-600 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="date" id="v_fecha" class="p-3 border rounded-xl bg-gray-50">
                    <input type="text" id="v_orden" placeholder="No. Orden de Venta" class="p-3 border rounded-xl font-bold text-blue-600">
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div class="grid grid-cols-2 gap-2">
                        <select id="v_cliente" onchange="filtrarVehiculos()" class="p-3 border rounded-xl bg-yellow-50 font-bold"></select>
                        <select id="v_placa" onchange="autoCompletarArea()" class="p-3 border rounded-xl bg-blue-50 font-bold"></select>
                    </div>
                    <input type="text" id="v_area" placeholder="Área de Trabajo" class="p-3 border rounded-xl bg-gray-50 italic">
                    <select id="v_prod" onchange="asignarPrecioAuto()" class="p-3 border rounded-xl font-bold text-blue-900 border-2 border-blue-200">
                        <option value="">-- Combustible --</option>
                        <option value="Súper">Gasolina Súper</option>
                        <option value="Regular">Gasolina Regular</option>
                        <option value="Diésel">Diésel</option>
                        <option value="ANULADA">--- ORDEN ANULADA ---</option>
                    </select>

                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-[9px] font-bold text-gray-400 uppercase">Gls (0=Anular)</label>
                            <input type="number" id="v_cant" oninput="calcVenta()" class="w-full p-3 border rounded-xl font-bold text-xl">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-gray-400 uppercase">Precio</label>
                            <input type="number" id="v_precio" oninput="calcVenta()" class="w-full p-3 border rounded-xl font-bold text-xl bg-gray-100">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-red-400 uppercase">Desc $</label>
                            <input type="number" id="v_desc" oninput="calcVenta()" value="0" class="w-full p-3 border rounded-xl font-bold text-xl bg-red-50">
                        </div>
                    </div>
                </div>

                <div class="mt-4 bg-slate-900 text-white p-4 rounded-xl flex justify-between items-center">
                    <span class="text-2xl font-black text-green-400">$ <span id="v_total">0.00</span></span>
                    <input type="hidden" id="v_edit_index" value="-1">
                    <div class="flex space-x-2">
                        <button onclick="cancelarVenta()" class="bg-slate-600 px-4 py-2 rounded-lg font-bold uppercase text-xs">Cancelar</button>
                        <button id="btn-registrar" onclick="realizarVenta()" class="bg-blue-600 px-6 py-2 rounded-lg font-bold uppercase text-sm">Registrar</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-3 bg-gray-200 flex justify-between items-center">
                    <span class="text-xs font-bold uppercase text-gray-600">Últimas Ventas</span>
                    <button onclick="exportarExcel()" class="bg-green-700 text-white px-2 py-1 rounded text-[10px] font-bold">EXPORTAR VENTAS + TOTALES</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-[11px] text-left border-collapse">
                        <thead class="bg-gray-50 border-b text-gray-400 uppercase text-[9px]">
                            <tr><th class="p-2">Fecha/Orden</th><th class="p-2">Cliente/Placa</th><th class="p-2">Área</th><th class="p-2">Detalle</th><th class="p-2 text-right">Total</th><th class="p-2 text-center">⚙️</th></tr>
                        </thead>
                        <tbody id="lista_ventas" class="divide-y italic text-gray-600"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="sec-admin" class="hidden">
            <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200 mb-6">
                <h3 class="font-black text-blue-900 text-sm mb-2"><i class="fas fa-shield-alt"></i> SISTEMA DE SEGURIDAD DE DATOS</h3>
                <p class="text-[11px] text-blue-700 mb-4">Descarga una copia de seguridad antes de cualquier actualización o para mover tus datos a otra computadora.</p>
                <div class="flex flex-col md:flex-row gap-2">
                    <button onclick="descargarBackup()" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-bold text-xs uppercase shadow-md"><i class="fas fa-download mr-2"></i> Descargar Copia de Seguridad (JSON)</button>
                    <div class="flex-1 relative">
                        <input type="file" id="fileInput" class="hidden" onchange="restaurarBackup(event)">
                        <button onclick="document.getElementById('fileInput').click()" class="w-full bg-white border-2 border-blue-600 text-blue-600 p-3 rounded-lg font-bold text-xs uppercase hover:bg-blue-100"><i class="fas fa-upload mr-2"></i> Restaurar Copia Anterior</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
                    <h3 class="font-bold mb-2 uppercase text-xs">Añadir Empresa</h3>
                    <input type="text" id="adm_c_nom" placeholder="Nombre de la Empresa" class="w-full p-2 border rounded mb-2 font-bold">
                    <button onclick="addCliente()" class="w-full bg-slate-800 text-white p-2 rounded text-xs font-bold">Añadir Cliente</button>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-yellow-500">
                    <h3 class="font-bold mb-2 uppercase text-xs text-yellow-700">Vincular Placa y Área</h3>
                    <select id="adm_v_cli" class="w-full p-2 border rounded mb-2 font-bold"></select>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="adm_v_pla" placeholder="Placa" class="w-full p-2 border rounded uppercase font-bold">
                        <input type="text" id="adm_v_area" placeholder="Área Base" class="w-full p-2 border rounded">
                    </div>
                    <button onclick="addVehiculo()" class="w-full bg-yellow-600 text-white p-2 rounded text-xs font-bold">Vincular</button>
                </div>
            </div>
            <button onclick="borrarTodo()" class="w-full text-red-500 text-[10px] underline pt-20">BORRAR BASE DE DATOS LOCAL COMPLETAMENTE</button>
        </section>

    </main>

    <script>
        // CARGA SEGURA DE DATOS
        let app = JSON.parse(localStorage.getItem('fuelDB')) || {
            clientes: [], vehiculos: [], ventas: [], compras: [],
            stock: { "Súper": 0, "Regular": 0, "Diésel": 0 },
            precios: { "Súper": 0, "Regular": 0, "Diésel": 0 }
        };

        function save() {
            localStorage.setItem('fuelDB', JSON.stringify(app));
            actualizarUI();
            renderVentas();
            renderCompras();
        }

        function verTab(t) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-' + t).classList.remove('hidden');
        }

        // --- SISTEMA DE BACKUP ---
        function descargarBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "FUEL_BACKUP_" + new Date().toLocaleDateString() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function restaurarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm("¿Estás seguro? Esto reemplazará tus registros actuales con los de la copia.")) {
                        app = data;
                        save();
                        location.reload();
                    }
                } catch (err) {
                    alert("Error al leer el archivo de copia.");
                }
            };
            reader.readAsText(file);
        }

        // --- ABASTECIMIENTO ---
        function calcCostoCompra() {
            const cant = parseFloat(document.getElementById('c_cant').value) || 0;
            const total = parseFloat(document.getElementById('c_costo_total').value) || 0;
            document.getElementById('c_unitario_show').innerText = "$" + (cant > 0 ? (total / cant).toFixed(2) : "0.00");
        }

        function registrarCompra() {
            const f = document.getElementById('c_fecha').value;
            const fac = document.getElementById('c_factura').value;
            const prod = document.getElementById('c_prod').value;
            const cant = parseFloat(document.getElementById('c_cant').value) || 0;
            const totalC = parseFloat(document.getElementById('c_costo_total').value) || 0;
            const precioV = parseFloat(document.getElementById('c_precio_venta').value) || 0;
            const editIndex = parseInt(document.getElementById('c_edit_index').value);

            if (!f || cant <= 0 || totalC <= 0 || precioV <= 0) return alert("Faltan datos de compra");

            const unitario = totalC / cant;
            const datos = { fecha: f, factura: fac, producto: prod, cantidad: cant, costoTotal: totalC, unitario: unitario, precioVenta: precioV, totalVenta: cant * precioV, utilidad: (cant * precioV) - totalC };

            if (editIndex > -1) {
                app.stock[app.compras[editIndex].producto] -= app.compras[editIndex].cantidad;
                app.compras[editIndex] = datos;
            } else {
                app.compras.unshift(datos);
            }
            app.stock[prod] += cant;
            app.precios[prod] = precioV;
            save();
            cancelarCompra();
        }

        function editarCompra(index) {
            const c = app.compras[index];
            document.getElementById('c_fecha').value = c.fecha;
            document.getElementById('c_factura').value = c.factura;
            document.getElementById('c_prod').value = c.producto;
            document.getElementById('c_cant').value = c.cantidad;
            document.getElementById('c_costo_total').value = c.costoTotal;
            document.getElementById('c_precio_venta').value = c.precioVenta;
            document.getElementById('c_edit_index').value = index;
            document.getElementById('btn-comprar').innerText = "Actualizar Compra";
            calcCostoCompra();
        }

        function eliminarCompra(index) {
            if (confirm("¿Eliminar abastecimiento? El stock bajará.")) {
                const c = app.compras[index];
                app.stock[c.producto] -= c.cantidad;
                app.compras.splice(index, 1);
                save();
            }
        }

        function cancelarCompra() {
            document.getElementById('c_edit_index').value = "-1";
            document.getElementById('btn-comprar').innerText = "Guardar Compra";
            document.getElementById('c_cant').value = "";
            document.getElementById('c_costo_total').value = "";
            document.getElementById('c_factura').value = "";
            document.getElementById('c_unitario_show').innerText = "$0.00";
        }

        function renderCompras() {
            const t = document.getElementById('lista_compras');
            t.innerHTML = app.compras.map((c, index) => `
                        <tr>
                            <td class="p-2 border-b"><b>${c.fecha}</b><br><small>${c.factura || 'S/N'}</small></td>
                            <td class="p-2 border-b font-bold">${c.producto}</td>
                            <td class="p-2 border-b text-center">${c.cantidad}</td>
                            <td class="p-2 border-b text-center">$${c.unitario.toFixed(2)}</td>
                            <td class="p-2 border-b text-right font-bold text-orange-600">$${c.costoTotal.toFixed(2)}</td>
                            <td class="p-2 border-b text-center">
                                <button onclick="editarCompra(${index})" class="text-blue-500 mr-2"><i class="fas fa-edit"></i></button>
                                <button onclick="eliminarCompra(${index})" class="text-red-500"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`).join('');
        }

        function exportarExcelCompras() {
            let data = JSON.parse(JSON.stringify(app.compras));
            data.push({
                fecha: "TOTALES", factura: "", producto: "",
                cantidad: data.reduce((s, a) => s + a.cantidad, 0),
                costoTotal: data.reduce((s, a) => s + a.costoTotal, 0),
                unitario: 0, precioVenta: 0, totalVenta: 0, utilidad: data.reduce((s, a) => s + a.utilidad, 0)
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Abastecimiento");
            XLSX.writeFile(wb, "Historial_Compras.xlsx");
        }

        // --- VENTAS ---
        function autoCompletarArea() {
            const p = document.getElementById('v_placa').value;
            const veh = app.vehiculos.find(v => v.placa === p);
            if (veh) document.getElementById('v_area').value = veh.area || "";
        }

        function asignarPrecioAuto() {
            const p = document.getElementById('v_prod').value;
            if (p !== "ANULADA") document.getElementById('v_precio').value = app.precios[p] || 0;
            else document.getElementById('v_precio').value = 0;
            calcVenta();
        }

        function calcVenta() {
            const c = parseFloat(document.getElementById('v_cant').value) || 0;
            const p = parseFloat(document.getElementById('v_precio').value) || 0;
            const d = parseFloat(document.getElementById('v_desc').value) || 0;
            document.getElementById('v_total').innerText = ((c * p) - d).toFixed(2);
        }

        function realizarVenta() {
            const prod = document.getElementById('v_prod').value;
            const cant = parseFloat(document.getElementById('v_cant').value) || 0;
            const cid = document.getElementById('v_cliente').value;
            const placa = document.getElementById('v_placa').value;
            const editIndex = parseInt(document.getElementById('v_edit_index').value);

            if (!prod || !placa || !cid) return alert("Faltan datos");

            const cli = app.clientes.find(c => c.id == cid);

            if (editIndex > -1) {
                const vOld = app.ventas[editIndex];
                if (vOld.producto !== "--- ANULADA ---") app.stock[vOld.producto] += vOld.cantidad;
            }

            if (cant > 0 && prod !== "ANULADA") {
                if (cant > app.stock[prod]) {
                    if (editIndex > -1) app.stock[app.ventas[editIndex].producto] -= app.ventas[editIndex].cantidad;
                    return alert("Stock insuficiente");
                }
                app.stock[prod] -= cant;
            }

            const nuevaVenta = {
                fecha: document.getElementById('v_fecha').value,
                orden: document.getElementById('v_orden').value,
                cliente: cli.nombre,
                placa: placa,
                area: document.getElementById('v_area').value,
                producto: (cant === 0 || prod === "ANULADA") ? "--- ANULADA ---" : prod,
                cantidad: cant,
                precio: parseFloat(document.getElementById('v_precio').value) || 0,
                descuento: parseFloat(document.getElementById('v_desc').value) || 0,
                total: parseFloat(document.getElementById('v_total').innerText),
                clienteId: cid
            };

            if (editIndex > -1) app.ventas[editIndex] = nuevaVenta;
            else {
                app.ventas.unshift(nuevaVenta);
                let ord = document.getElementById('v_orden').value;
                if (!isNaN(ord) && ord !== "") document.getElementById('v_orden').value = parseInt(ord) + 1;
            }
            save(); cancelarVenta();
        }

        function cancelarVenta() {
            document.getElementById('v_edit_index').value = "-1";
            document.getElementById('btn-registrar').innerText = "Registrar";
            document.getElementById('v_cant').value = "";
            document.getElementById('v_desc').value = "0";
            document.getElementById('v_total').innerText = "0.00";
        }

        function editarVenta(index) {
            const v = app.ventas[index];
            document.getElementById('v_fecha').value = v.fecha;
            document.getElementById('v_orden').value = v.orden;
            document.getElementById('v_cliente').value = v.clienteId;
            filtrarVehiculos();
            document.getElementById('v_placa').value = v.placa;
            document.getElementById('v_area').value = v.area;
            document.getElementById('v_prod').value = (v.producto === "--- ANULADA ---") ? "ANULADA" : v.producto;
            document.getElementById('v_cant').value = v.cantidad;
            document.getElementById('v_precio').value = v.precio;
            document.getElementById('v_desc').value = v.descuento;
            document.getElementById('v_total').innerText = v.total;
            document.getElementById('v_edit_index').value = index;
            document.getElementById('btn-registrar').innerText = "Actualizar Venta";
            verTab('ventas');
        }

        function eliminarVenta(index) {
            if (confirm("¿Eliminar?")) {
                const v = app.ventas[index];
                if (v.producto !== "--- ANULADA ---") app.stock[v.producto] += v.cantidad;
                app.ventas.splice(index, 1);
                save();
            }
        }

        function exportarExcel() {
            let data = JSON.parse(JSON.stringify(app.ventas));
            data.push({
                fecha: "TOTALES", orden: "", cliente: "", placa: "", area: "", producto: "",
                cantidad: data.reduce((s, a) => s + a.cantidad, 0),
                precio: 0, descuento: data.reduce((s, a) => s + a.descuento, 0),
                total: data.reduce((s, a) => s + a.total, 0)
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ventas");
            XLSX.writeFile(wb, "Historial_Ventas.xlsx");
        }

        // --- ADMIN ---
        function addCliente() {
            const n = document.getElementById('adm_c_nom').value;
            if (!n) return;
            app.clientes.push({ id: Date.now(), nombre: n });
            save(); actualizarSelects();
            document.getElementById('adm_c_nom').value = "";
        }

        function addVehiculo() {
            const p = document.getElementById('adm_v_pla').value.toUpperCase();
            const c = document.getElementById('adm_v_cli').value;
            const a = document.getElementById('adm_v_area').value;
            if (!p || !c) return;
            app.vehiculos.push({ placa: p, cid: c, area: a });
            save();
            document.getElementById('adm_v_pla').value = "";
            document.getElementById('adm_v_area').value = "";
        }

        function actualizarSelects() {
            const s1 = document.getElementById('adm_v_cli');
            const s2 = document.getElementById('v_cliente');
            s1.innerHTML = s2.innerHTML = '<option value="">-- Seleccionar --</option>';
            app.clientes.forEach(c => {
                const h = `<option value="${c.id}">${c.nombre}</option>`;
                s1.innerHTML += h; s2.innerHTML += h;
            });
        }

        function filtrarVehiculos() {
            const cid = document.getElementById('v_cliente').value;
            const sv = document.getElementById('v_placa');
            sv.innerHTML = '<option value="">-- Placa --</option>';
            app.vehiculos.filter(v => v.cid == cid).forEach(v => {
                sv.innerHTML += `<option value="${v.placa}">${v.placa}</option>`;
            });
        }

        function actualizarUI() {
            document.getElementById('stk_super').innerText = (app.stock["Súper"] || 0).toFixed(1);
            document.getElementById('stk_regular').innerText = (app.stock["Regular"] || 0).toFixed(1);
            document.getElementById('stk_diesel').innerText = (app.stock["Diésel"] || 0).toFixed(1);
            document.getElementById('prc_super').innerText = app.precios["Súper"];
            document.getElementById('prc_regular').innerText = app.precios["Regular"];
            document.getElementById('prc_diesel').innerText = app.precios["Diésel"];
        }

        function renderVentas() {
            const t = document.getElementById('lista_ventas');
            t.innerHTML = app.ventas.map((v, index) => {
                const colorTotal = v.cantidad === 0 ? 'text-red-400' : 'text-emerald-700';
                return `
                        <tr class="${v.cantidad === 0 ? 'bg-red-50' : ''}">
                            <td class="p-2 border-b"><b>${v.fecha}</b><br><small class="text-blue-500 font-bold">Ord: ${v.orden}</small></td>
                            <td class="p-2 border-b"><div class="font-bold text-blue-900">${v.cliente}</div><div class="font-black">${v.placa}</div></td>
                            <td class="p-2 border-b text-[9px] text-gray-400 uppercase">${v.area || 'General'}</td>
                            <td class="p-2 border-b font-bold ${v.cantidad === 0 ? 'text-red-600' : ''}">${v.producto} <br> <small>${v.cantidad} Gls</small></td>
                            <td class="p-2 border-b text-right font-black ${colorTotal}">$${v.total.toFixed(2)}</td>
                            <td class="p-2 border-b text-center">
                                <button onclick="editarVenta(${index})" class="text-blue-500 mr-2"><i class="fas fa-edit"></i></button>
                                <button onclick="eliminarVenta(${index})" class="text-red-500"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
            }).join('');
        }

        function borrarTodo() { if (confirm("¿BORRAR TODO? Esto no se puede deshacer a menos que tengas un backup.")) { localStorage.clear(); location.reload(); } }

        document.getElementById('v_fecha').valueAsDate = new Date();
        document.getElementById('c_fecha').valueAsDate = new Date();
        actualizarUI(); renderVentas(); renderCompras(); actualizarSelects();
    </script>
</body>
</html>