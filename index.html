<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FuelSystem Pro v7.0 - CLOUD SYNC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-100 min-h-screen pb-20">

    <nav class="bg-blue-900 text-white p-4 sticky top-0 z-50 shadow-xl">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="font-black italic text-lg text-yellow-400">⛽ FUEL-MASTER CLOUD v7.0</h1>
            <div class="flex space-x-1 text-[10px] font-bold">
                <button onclick="verTab('ventas')" class="bg-blue-700 px-2 py-1 rounded">VENTAS</button>
                <button onclick="verTab('compras')" class="bg-emerald-700 px-2 py-1 rounded">COMPRAS</button>
                <button onclick="verTab('contabilidad')" class="bg-purple-700 px-2 py-1 rounded">REPORTES</button>
                <button onclick="verTab('admin')" class="bg-slate-700 px-2 py-1 rounded">ADMIN</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-2 max-w-6xl">
        <div class="grid grid-cols-3 gap-2 mb-4 text-center font-bold">
            <div class="bg-white p-2 rounded shadow border-b-4 border-orange-500">
                <p class="text-[10px] text-gray-400 uppercase">Súper</p>
                <p class="text-sm"><span id="stk_super">0</span> <small>Gls</small></p>
            </div>
            <div class="bg-white p-2 rounded shadow border-b-4 border-red-500">
                <p class="text-[10px] text-gray-400 uppercase">Regular</p>
                <p class="text-sm"><span id="stk_regular">0</span> <small>Gls</small></p>
            </div>
            <div class="bg-white p-2 rounded shadow border-b-4 border-black">
                <p class="text-[10px] text-gray-400 uppercase">Diésel</p>
                <p class="text-sm"><span id="stk_diesel">0</span> <small>Gls</small></p>
            </div>
        </div>

        <section id="sec-ventas">
            <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-blue-600 mb-6">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <input type="date" id="v_fecha" class="p-3 border rounded-xl bg-gray-50">
                    <input type="text" id="v_orden" placeholder="No. Orden" class="p-3 border rounded-xl font-bold text-blue-600">
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div class="grid grid-cols-2 gap-2">
                        <select id="v_cliente" onchange="filtrarPlacas()" class="p-3 border rounded-xl">
                            <option value="">-- Cliente --</option>
                        </select>
                        <select id="v_placa" onchange="actualizarArea()" class="p-3 border rounded-xl bg-blue-50 font-bold">
                            <option value="">-- Placa --</option>
                        </select>
                    </div>
                    <input type="text" id="v_area" placeholder="Área" class="p-3 border rounded-xl bg-gray-50 italic">
                    <select id="v_prod" onchange="asignarPrecioAuto()" class="p-3 border rounded-xl font-bold border-blue-200">
                        <option value="">-- Combustible --</option>
                        <option value="Súper">Súper</option>
                        <option value="Regular">Regular</option>
                        <option value="Diésel">Diésel</option>
                        <option value="ANULADA">ANULADA</option>
                    </select>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="v_cant" oninput="calcVenta()" placeholder="Gls" class="p-3 border rounded-xl font-bold">
                        <input type="number" id="v_precio" oninput="calcVenta()" placeholder="$" class="p-3 border rounded-xl bg-gray-100 font-bold">
                        <input type="number" id="v_desc" oninput="calcVenta()" value="0" class="p-3 border rounded-xl bg-red-50 text-red-600 font-bold">
                    </div>
                </div>
                <div class="mt-4 bg-slate-900 text-white p-4 rounded-xl flex justify-between items-center">
                    <span class="text-2xl font-black text-green-400">$ <span id="v_total">0.00</span></span>
                    <input type="hidden" id="v_edit_index" value="-1">
                    <div class="flex space-x-2">
                        <button onclick="cancelarVenta()" class="bg-slate-600 px-3 py-2 rounded-lg font-bold text-[10px]">LIMPIAR</button>
                        <button id="btn-registrar" onclick="realizarVenta()" class="bg-blue-600 px-6 py-2 rounded-lg font-bold uppercase text-xs">Guardar</button>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-3 bg-gray-800 text-white flex justify-between items-center">
                    <span class="text-[10px] font-bold uppercase">Registro Local</span>
                    <button onclick="exportarVentasExcel()" class="bg-green-600 px-2 py-1 rounded text-[10px]">EXCEL</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-[11px] text-left border-collapse">
                        <thead class="bg-gray-100 border-b">
                            <tr><th class="p-2">Fecha/Ord</th><th class="p-2">Placa</th><th class="p-2">Detalle</th><th class="p-2 text-right">Total</th><th class="p-2 text-center">⚙️</th></tr>
                        </thead>
                        <tbody id="lista_ventas" class="divide-y italic"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="sec-compras" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-emerald-600 mb-6">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <input type="date" id="c_fecha" class="p-3 border rounded-xl">
                    <input type="text" id="c_factura" placeholder="No. Factura" class="p-3 border rounded-xl font-bold">
                </div>
                <select id="c_prod" class="w-full p-3 border rounded-xl font-bold bg-gray-50 mb-4">
                    <option value="Súper">Súper</option>
                    <option value="Regular">Regular</option>
                    <option value="Diésel">Diésel</option>
                </select>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <input type="number" id="c_cant" oninput="calcCostoCompra()" placeholder="Gls" class="p-3 border rounded-xl">
                    <input type="number" id="c_costo_total" oninput="calcCostoCompra()" placeholder="Total $" class="p-3 border rounded-xl">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="p-2 bg-gray-100 rounded text-center text-[10px]">Costo Unit: <span id="c_unitario_show" class="font-bold text-orange-600">$0.00</span></div>
                    <input type="number" id="c_precio_venta" placeholder="Precio Venta" class="p-3 border rounded-xl bg-blue-50 font-bold">
                </div>
                <div class="flex space-x-2">
                    <input type="hidden" id="c_edit_index" value="-1">
                    <button onclick="cancelarCompra()" class="bg-slate-500 text-white px-4 py-3 rounded-xl font-bold text-xs">LIMPIAR</button>
                    <button id="btn-comprar" onclick="registrarCompra()" class="flex-1 bg-emerald-600 text-white p-4 rounded-xl font-bold uppercase">Guardar Compra</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <tbody id="lista_compras"></tbody>
            </div>
        </section>

        <section id="sec-contabilidad" class="hidden">
             <div class="bg-purple-900 text-white p-4 rounded-2xl mb-4 flex gap-2">
                <input type="date" id="cont_desde" class="p-2 rounded bg-purple-800 text-xs text-white">
                <input type="date" id="cont_hasta" class="p-2 rounded bg-purple-800 text-xs text-white">
                <button onclick="calcularContabilidad()" class="bg-yellow-500 text-black px-4 rounded font-bold text-xs uppercase">Filtrar</button>
            </div>
            <div class="bg-white p-4 rounded-xl shadow mb-4"><canvas id="chartVentas" style="max-height: 200px;"></canvas></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl shadow border-t-4 border-blue-500">
                    <h3 class="font-bold text-xs mb-2">POR PLACA</h3>
                    <div class="max-h-40 overflow-y-auto"><table class="w-full text-[10px]"><tbody id="res_por_placa"></tbody></table></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-t-4 border-green-500">
                    <h3 class="font-bold text-xs mb-2">POR ÁREA</h3>
                    <div class="max-h-40 overflow-y-auto"><table class="w-full text-[10px]"><tbody id="res_por_area"></tbody></table></div>
                </div>
            </div>
        </section>

        <section id="sec-admin" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow">
                <button onclick="borrarTodo()" class="w-full text-red-500 underline text-[10px] font-black uppercase">Borrar toda la base de datos local</button>
            </div>
        </section>
    </main>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx9nwCa6lzlVMnE6J5KIoDDGZFxW-4fUy-sbjwcSNcQ0_XyUXCv7vx0ogxYsIHldor_Xw/exec";
        
        let app = JSON.parse(localStorage.getItem('fuelDB')) || {
            clientes: [], vehiculos: [], ventas: [], compras: [],
            precios: { "Súper": 0, "Regular": 0, "Diésel": 0 }
        };
        let myChart = null;

        window.onload = () => {
            actualizarTodo();
            verTab('ventas');
        };

        // --- LIMPIEZA DE DATOS ---
        function obtenerValor(obj, clave) {
            if (!obj) return "";
            return obj[clave.toLowerCase()] || obj[clave.toUpperCase()] || "";
        }

        function limpiarNum(v) {
            if (v === null || v === undefined || v === "") return 0;
            if (typeof v === "number") return v;
            let res = String(v).replace(/[^0-9.]/g, '');
            return parseFloat(res) || 0;
        }

        // --- NAVEGACIÓN ---
        function verTab(t) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-' + t).classList.remove('hidden');
            if (t === 'contabilidad') calcularContabilidad();
        }

        // --- SYNC ---
        async function save(datosNube = null) {
            localStorage.setItem('fuelDB', JSON.stringify(app));
            actualizarUI();
            renderVentas();
            renderCompras();

            if (datosNube) {
                try {
                    const params = new URLSearchParams();
                    for (let key in datosNube) params.append(key, datosNube[key]);
                    fetch(WEB_APP_URL + "?" + params.toString(), { mode: 'no-cors' });
                } catch (e) { console.error("Error nube", e); }
            }
        }

        async function actualizarTodo() {
            try {
                const res = await fetch(WEB_APP_URL + "?action=readDB");
                const data = await res.json();
                if (data) {
                    app.clientes = data.clientes || [];
                    app.vehiculos = data.vehiculos || [];
                    app.ventas = data.ventas || [];
                    app.compras = data.compras || [];
                    
                    // Extraer precios de la última compra de cada producto
                    ["Súper", "Regular", "Diésel"].forEach(p => {
                        const ultima = app.compras.filter(c => obtenerValor(c, 'producto') === p)[0];
                        if (ultima) app.precios[p] = limpiarNum(obtenerValor(ultima, 'precioVenta'));
                    });
                }
            } catch (e) { console.warn("Modo Offline"); }
            
            actualizarSelects();
            actualizarUI();
            renderVentas();
            renderCompras();
        }

        // --- LOGICA UI ---
        function actualizarUI() {
            const prods = ["Súper", "Regular", "Diésel"];
            prods.forEach(p => {
                const stockID = "stk_" + p.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                
                const totalComp = app.compras.reduce((acc, curr) => {
                    return obtenerValor(curr, 'producto') === p ? acc + limpiarNum(obtenerValor(curr, 'cantidad')) : acc;
                }, 0);
                
                const totalVent = app.ventas.reduce((acc, curr) => {
                    return obtenerValor(curr, 'producto') === p ? acc + limpiarNum(obtenerValor(curr, 'cantidad')) : acc;
                }, 0);

                const el = document.getElementById(stockID);
                if (el) el.innerText = (totalComp - totalVent).toFixed(1);
            });
        }

        function renderVentas() {
            const tbody = document.getElementById('lista_ventas');
            if (!tbody) return;
            tbody.innerHTML = app.ventas.map((v, i) => {
                const total = limpiarNum(obtenerValor(v, 'total'));
                return `
                <tr class="border-b">
                    <td class="p-2">${obtenerValor(v, 'fecha')}<br><b class="text-blue-600">${obtenerValor(v, 'orden')}</b></td>
                    <td class="p-2 font-bold">${obtenerValor(v, 'placa')}</td>
                    <td class="p-2">${obtenerValor(v, 'producto')}<br>${obtenerValor(v, 'cantidad')} Gls</td>
                    <td class="p-2 text-right font-bold text-blue-700">$${total.toFixed(2)}</td>
                    <td class="p-2 text-center">
                        <button onclick="editarVenta(${i})" class="text-blue-500">✎</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderCompras() {
            // Implementación similar si necesitas ver la lista de compras
        }

        // --- FORMULARIO VENTAS ---
        function filtrarPlacas() {
            const cid = document.getElementById('v_cliente').value;
            const filtrados = app.vehiculos.filter(v => String(obtenerValor(v, 'cid')) === String(cid));
            let h = '<option value="">-- Placa --</option>';
            filtrados.forEach(v => { h += `<option value="${obtenerValor(v, 'placa')}">${obtenerValor(v, 'placa')}</option>`; });
            document.getElementById('v_placa').innerHTML = h;
        }

        function actualizarArea() {
            const placa = document.getElementById('v_placa').value;
            const v = app.vehiculos.find(x => obtenerValor(x, 'placa') === placa);
            if (v) document.getElementById('v_area').value = obtenerValor(v, 'area');
        }

        function asignarPrecioAuto() {
            const p = document.getElementById('v_prod').value;
            document.getElementById('v_precio').value = app.precios[p] || 0;
            calcVenta();
        }

        function calcVenta() {
            const c = limpiarNum(document.getElementById('v_cant').value);
            const p = limpiarNum(document.getElementById('v_precio').value);
            const d = limpiarNum(document.getElementById('v_desc').value);
            document.getElementById('v_total').innerText = ((c * p) - d).toFixed(2);
        }

        function realizarVenta() {
            const prod = document.getElementById('v_prod').value;
            const cant = limpiarNum(document.getElementById('v_cant').value);
            const idx = parseInt(document.getElementById('v_edit_index').value);

            const ven = {
                tipo: "VENTAS",
                fecha: document.getElementById('v_fecha').value,
                orden: document.getElementById('v_orden').value,
                cliente: document.getElementById('v_cliente').selectedOptions[0].text,
                placa: document.getElementById('v_placa').value,
                area: document.getElementById('v_area').value,
                producto: prod,
                cantidad: cant,
                precio: limpiarNum(document.getElementById('v_precio').value),
                descuento: limpiarNum(document.getElementById('v_desc').value),
                total: limpiarNum(document.getElementById('v_total').innerText),
                clienteId: document.getElementById('v_cliente').value
            };

            if (idx > -1) app.ventas[idx] = ven;
            else app.ventas.unshift(ven);

            save(ven);
            cancelarVenta();
        }

        function cancelarVenta() {
            document.getElementById('v_edit_index').value = "-1";
            document.getElementById('v_cant').value = "";
            document.getElementById('v_total').innerText = "0.00";
            document.getElementById('btn-registrar').innerText = "Guardar";
        }

        function editarVenta(i) {
            const v = app.ventas[i];
            document.getElementById('v_fecha').value = obtenerValor(v, 'fecha');
            document.getElementById('v_orden').value = obtenerValor(v, 'orden');
            document.getElementById('v_cliente').value = obtenerValor(v, 'clienteId');
            filtrarPlacas();
            document.getElementById('v_placa').value = obtenerValor(v, 'placa');
            document.getElementById('v_area').value = obtenerValor(v, 'area');
            document.getElementById('v_prod').value = obtenerValor(v, 'producto');
            document.getElementById('v_cant').value = obtenerValor(v, 'cantidad');
            document.getElementById('v_precio').value = obtenerValor(v, 'precio');
            document.getElementById('v_desc').value = obtenerValor(v, 'descuento');
            calcVenta();
            document.getElementById('v_edit_index').value = i;
            document.getElementById('btn-registrar').innerText = "Actualizar";
            verTab('ventas');
        }

        function actualizarSelects() {
            let h = '<option value="">-- Cliente --</option>';
            app.clientes.forEach(c => { h += `<option value="${obtenerValor(c, 'id')}">${obtenerValor(c, 'nombre')}</option>`; });
            document.getElementById('v_cliente').innerHTML = h;
        }

        function calcularContabilidad() {
            const d = document.getElementById('cont_desde').value;
            const h = document.getElementById('cont_hasta').value;
            let f = app.ventas;
            if (d) f = f.filter(v => obtenerValor(v, 'fecha') >= d);
            if (h) f = f.filter(v => obtenerValor(v, 'fecha') <= h);

            const agP = {};
            f.forEach(v => {
                const p = (obtenerValor(v, 'placa') || "S/P").toUpperCase();
                if (!agP[p]) agP[p] = { g: 0, t: 0 };
                agP[p].g += limpiarNum(obtenerValor(v, 'cantidad'));
                agP[p].t += limpiarNum(obtenerValor(v, 'total'));
            });
            document.getElementById('res_por_placa').innerHTML = Object.entries(agP).map(([p, d]) => `<tr><td class="p-1">${p}</td><td class="text-center font-bold">${d.g.toFixed(1)}</td><td class="text-right">$${d.t.toFixed(2)}</td></tr>`).join('');
        }

        function borrarTodo() { if (confirm("¿Borrar TODO?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
