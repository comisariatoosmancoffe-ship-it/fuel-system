<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FuelMaster Pro v8.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></script>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-2xl border-b-2 border-yellow-500">
        <div class="flex justify-between items-center max-w-6xl mx-auto">
            <h1 class="font-black italic text-xl tracking-tighter">FUEL<span class="text-yellow-400">MASTER</span></h1>
            <div class="flex gap-2">
                <button onclick="sincronizar()" class="bg-blue-600 px-3 py-1 rounded-lg text-xs font-bold">
                    <i class="fas fa-sync"></i> SYNC
                </button>
                <div id="status-cloud" class="w-3 h-3 bg-red-500 rounded-full animate-pulse mt-2"></div>
            </div>
        </div>
        <div class="flex justify-around mt-4 text-[10px] font-bold uppercase tracking-widest">
            <button onclick="verTab('ventas')" class="tab-btn border-b-2 border-yellow-400 pb-1" id="tab-ventas">Ventas</button>
            <button onclick="verTab('compras')" class="tab-btn border-b-2 border-transparent pb-1" id="tab-compras">Compras</button>
            <button onclick="verTab('reportes')" class="tab-btn border-b-2 border-transparent pb-1" id="tab-reportes">Reportes</button>
            <button onclick="verTab('admin')" class="tab-btn border-b-2 border-transparent pb-1" id="tab-admin">Admin</button>
        </div>
    </nav>

    <main class="p-3 max-w-6xl mx-auto">
        <div class="grid grid-cols-3 gap-2 mb-4">
            <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-orange-500">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Súper</p>
                <p class="text-lg font-black"><span id="inv-super">0</span> <small class="text-[10px] text-gray-400">Gls</small></p>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-red-500">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Regular</p>
                <p class="text-lg font-black"><span id="inv-regular">0</span> <small class="text-[10px] text-gray-400">Gls</small></p>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-gray-900">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Diesel</p>
                <p class="text-lg font-black"><span id="inv-diesel">0</span> <small class="text-[10px] text-gray-400">Gls</small></p>
            </div>
        </div>

        <section id="sec-ventas" class="tab-content">
            <div class="bg-white p-5 rounded-2xl shadow-lg mb-6 border border-gray-200">
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <input type="date" id="v-fecha" class="p-2 bg-gray-50 border rounded-lg text-sm">
                    <input type="text" id="v-orden" placeholder="No. Orden" class="p-2 bg-gray-50 border rounded-lg text-sm font-bold">
                </div>
                
                <div class="space-y-3">
                    <select id="v-cliente" onchange="cargarVehiculos()" class="w-full p-3 border rounded-xl bg-white shadow-sm font-semibold"></select>
                    <select id="v-placa" onchange="cargarArea()" class="w-full p-3 border rounded-xl bg-blue-50 font-bold"></select>
                    <input type="text" id="v-area" placeholder="Área" readonly class="w-full p-2 bg-gray-100 border rounded-lg text-xs italic">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <select id="v-producto" onchange="autoPrecio()" class="p-3 border rounded-xl font-bold bg-yellow-50">
                            <option value="">Producto</option>
                            <option value="Súper">Súper</option>
                            <option value="Regular">Regular</option>
                            <option value="Diésel">Diésel</option>
                        </select>
                        <input type="number" id="v-cant" oninput="calcVenta()" placeholder="Gls" class="p-3 border rounded-xl text-center font-black text-lg">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="v-precio" oninput="calcVenta()" placeholder="Precio $" class="p-2 border rounded-lg text-sm">
                        <input type="number" id="v-desc" oninput="calcVenta()" placeholder="Desc. $" class="p-2 border rounded-lg text-sm text-red-500">
                    </div>
                </div>

                <div class="mt-5 p-4 bg-slate-800 rounded-xl flex justify-between items-center text-white">
                    <div>
                        <p class="text-[10px] uppercase text-gray-400">Total a Cobrar</p>
                        <p class="text-2xl font-black text-green-400">$ <span id="v-total">0.00</span></p>
                    </div>
                    <button onclick="guardarVenta()" class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-xl font-bold uppercase text-sm shadow-lg active:scale-95 transition-all">Guardar</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="bg-gray-100 p-3 text-[10px] font-bold flex justify-between">
                    <span>HISTORIAL LOCAL</span>
                    <span id="contador-ventas">0 registros</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-[11px]">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="p-3">ORD/PLACA</th>
                                <th class="p-3">DETALLE</th>
                                <th class="p-3 text-right">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody id="lista-ventas" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="sec-compras" class="tab-content hidden">
            <div class="bg-emerald-50 p-5 rounded-2xl border-2 border-emerald-200 shadow-lg">
                <h3 class="font-bold mb-4 text-emerald-800 uppercase text-xs tracking-widest">Entrada de Inventario</h3>
                <div class="space-y-3">
                    <input type="date" id="c-fecha" class="w-full p-3 border rounded-xl">
                    <select id="c-producto" class="w-full p-3 border rounded-xl font-bold uppercase">
                        <option value="Súper">Súper</option>
                        <option value="Regular">Regular</option>
                        <option value="Diésel">Diésel</option>
                    </select>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="c-cant" placeholder="Gls Comprados" class="p-3 border rounded-xl">
                        <input type="number" id="c-costo" placeholder="Costo Total $" class="p-3 border rounded-xl">
                    </div>
                    <input type="number" id="c-venta" placeholder="Nuevo Precio Venta $" class="w-full p-3 border rounded-xl bg-blue-50 font-bold">
                    <button onclick="guardarCompra()" class="w-full bg-emerald-600 text-white p-4 rounded-xl font-black uppercase">Registrar Compra</button>
                </div>
            </div>
        </section>

        <section id="sec-reportes" class="tab-content hidden">
            <div id="reporte-vacio" class="text-center p-10 text-gray-400 italic text-sm">Cargando datos...</div>
            <div class="grid gap-4" id="reporte-container"></div>
        </section>

        <section id="sec-admin" class="tab-content hidden">
            <div class="bg-white p-6 rounded-2xl shadow border border-red-100">
                <h2 class="text-red-600 font-bold mb-4">Zona de Peligro</h2>
                <button onclick="limpiarCache()" class="w-full bg-red-50 text-red-600 p-4 rounded-xl text-xs font-bold border border-red-200 uppercase">Borrar Datos Locales y Recargar</button>
            </div>
        </section>
    </main>

    <script>
        // CONFIGURACIÓN CLOUD
        //const URL_APP = "TU_URL_DE_GOOGLE_APPS_SCRIPT_AQUI"; // REEMPLAZAR
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwCIJloPr3aulNtUsdQpd7Rlk0BzpIMc59zRRGV_GgV3YhLvybeseMxSJPGudxxID03iA/exec";
        // ESTADO DE LA APP
        let DB = {
            clientes: [],
            vehiculos: [],
            ventas: [],
            compras: [],
            precios: { "Súper": 0, "Regular": 0, "Diésel": 0 }
        };

        // AL CARGAR
        window.onload = async () => {
            document.getElementById('v-fecha').valueAsDate = new Date();
            cargarCache();
            await sincronizar();
        };

        // --- TRADUCTOR DE DATOS (IMPORTANTE PARA EL MOVIL) ---
        function getVal(obj, key) {
            if (!obj) return "";
            return obj[key.toLowerCase()] || obj[key.toUpperCase()] || obj[key] || "";
        }

        function forceNum(val) {
            let n = parseFloat(val);
            return isNaN(n) ? 0 : n;
        }

        // --- NAVEGACIÓN ---
        function verTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('border-yellow-400'));
            
            document.getElementById('sec-' + tabId).classList.remove('hidden');
            document.getElementById('tab-' + tabId).classList.add('border-yellow-400');
            
            if(tabId === 'reportes') generarReporte();
        }

        // --- LÓGICA DE DATOS ---
        async function sincronizar() {
            document.getElementById('status-cloud').classList.replace('bg-green-500', 'bg-red-500');
            try {
                const response = await fetch(`${URL_APP}?action=readDB`);
                const data = await response.json();
                
                if (data) {
                    DB.clientes = data.clientes || [];
                    DB.vehiculos = data.vehiculos || [];
                    DB.ventas = data.ventas || [];
                    DB.compras = data.compras || [];
                    
                    // Actualizar precios desde compras
                    ["Súper", "Regular", "Diésel"].forEach(p => {
                        const ult = DB.compras.reverse().find(c => getVal(c, 'producto') === p);
                        if(ult) DB.precios[p] = forceNum(getVal(ult, 'precioVenta'));
                    });

                    document.getElementById('status-cloud').classList.replace('bg-red-500', 'bg-green-500');
                    guardarCache();
                    actualizarUI();
                }
            } catch (e) {
                console.log("Offline mode");
            }
        }

        function actualizarUI() {
            // Rellenar Clientes
            let h = '<option value="">Seleccionar Cliente</option>';
            DB.clientes.forEach(c => h += `<option value="${getVal(c, 'id')}">${getVal(c, 'nombre')}</option>`);
            document.getElementById('v-cliente').innerHTML = h;

            // Calcular Inventario
            const inv = { "Súper": 0, "Regular": 0, "Diésel": 0 };
            DB.compras.forEach(c => inv[getVal(c, 'producto')] += forceNum(getVal(c, 'cantidad')));
            DB.ventas.forEach(v => inv[getVal(v, 'producto')] -= forceNum(getVal(v, 'cantidad')));
            
            document.getElementById('inv-super').innerText = inv["Súper"].toFixed(1);
            document.getElementById('inv-regular').innerText = inv["Regular"].toFixed(1);
            document.getElementById('inv-diesel').innerText = inv["Diésel"].toFixed(1);

            // Render Ventas
            const tbody = document.getElementById('lista-ventas');
            tbody.innerHTML = DB.ventas.slice(0, 20).map(v => `
                <tr class="border-b">
                    <td class="p-3 font-bold">#${getVal(v, 'orden')}<br><span class="text-blue-600">${getVal(v, 'placa')}</span></td>
                    <td class="p-3">${getVal(v, 'producto')}<br><span class="text-gray-400">${getVal(v, 'cantidad')} Gls</span></td>
                    <td class="p-3 text-right font-black text-blue-800">$${forceNum(getVal(v, 'total')).toFixed(2)}</td>
                </tr>
            `).join('');
            document.getElementById('contador-ventas').innerText = `${DB.ventas.length} registros`;
        }

        // --- FORMULARIO VENTAS ---
        function cargarVehiculos() {
            const cid = document.getElementById('v-cliente').value;
            const filtrados = DB.vehiculos.filter(v => String(getVal(v, 'cid')) === String(cid));
            let h = '<option value="">Placa</option>';
            filtrados.forEach(v => h += `<option value="${getVal(v, 'placa')}">${getVal(v, 'placa')}</option>`);
            document.getElementById('v-placa').innerHTML = h;
        }

        function cargarArea() {
            const placa = document.getElementById('v-placa').value;
            const veh = DB.vehiculos.find(v => getVal(v, 'placa') === placa);
            document.getElementById('v-area').value = veh ? getVal(veh, 'area') : "";
        }

        function autoPrecio() {
            const p = document.getElementById('v-producto').value;
            document.getElementById('v-precio').value = DB.precios[p] || 0;
            calcVenta();
        }

        function calcVenta() {
            const c = forceNum(document.getElementById('v-cant').value);
            const p = forceNum(document.getElementById('v-precio').value);
            const d = forceNum(document.getElementById('v-desc').value);
            document.getElementById('v-total').innerText = ((c * p) - d).toFixed(2);
        }

        async function guardarVenta() {
            const venta = {
                tipo: "VENTAS",
                fecha: document.getElementById('v-fecha').value,
                orden: document.getElementById('v-orden').value,
                placa: document.getElementById('v-placa').value,
                producto: document.getElementById('v-producto').value,
                cantidad: forceNum(document.getElementById('v-cant').value),
                precio: forceNum(document.getElementById('v-precio').value),
                descuento: forceNum(document.getElementById('v-desc').value),
                total: forceNum(document.getElementById('v-total').innerText),
                cliente: document.getElementById('v-cliente').selectedOptions[0].text
            };

            if (!venta.placa || venta.cantidad <= 0) return alert("Completa los datos");

            // Guardar local
            DB.ventas.unshift(venta);
            guardarCache();
            actualizarUI();

            // Enviar Nube
            const params = new URLSearchParams(venta);
            fetch(`${URL_APP}?${params.toString()}`, { mode: 'no-cors' });
            
            // Limpiar
            document.getElementById('v-cant').value = "";
            document.getElementById('v-orden').value = "";
            alert("✅ Venta Guardada");
        }

        // --- CACHE ---
        function guardarCache() { localStorage.setItem('fuel_db_v8', JSON.stringify(DB)); }
        function cargarCache() {
            const data = localStorage.getItem('fuel_db_v8');
            if (data) { DB = JSON.parse(data); actualizarUI(); }
        }
        function limpiarCache() { if(confirm("¿Borrar todo?")) { localStorage.clear(); location.reload(); } }

        // --- REPORTES ---
        function generarReporte() {
            const res = {};
            DB.ventas.forEach(v => {
                const area = getVal(v, 'area') || "Sin Área";
                if(!res[area]) res[area] = 0;
                res[area] += forceNum(getVal(v, 'total'));
            });

            document.getElementById('reporte-container').innerHTML = Object.entries(res).map(([a, t]) => `
                <div class="bg-white p-4 rounded-xl flex justify-between items-center shadow-sm">
                    <span class="font-bold text-xs uppercase">${a}</span>
                    <span class="font-black text-blue-600">$${t.toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('reporte-vacio').classList.add('hidden');
        }
    </script>
</body>
</html>

